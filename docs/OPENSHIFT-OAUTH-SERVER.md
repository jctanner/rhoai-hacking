# OpenShift OAuth Server Documentation

> **Note**: This documentation was generated by Cursor.ai (Claude 4 Sonnet) through source code analysis and targeted prompting. It provides an architectural overview based on scanning the codebase structure and key components.

## Overview

The OpenShift OAuth server provides authentication services for OpenShift clusters, enabling username/password authentication as an alternative to token-based auth used in upstream Kubernetes. It allows services to use oauth-proxy sidecars to gate authenticated traffic and initiate OAuth login flows when needed.

## Architecture Overview

### Core Components

```
┌─────────────────────────────────────────────────────────────────┐
│                    OpenShift OAuth Server                      │
├─────────────────────────────────────────────────────────────────┤
│ Entry Point: cmd/oauth-server/main.go                          │
│ Command Handler: pkg/cmd/oauth-server/                         │
├─────────────────────────────────────────────────────────────────┤
│                   HTTP Request Flow                            │
│ ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│ │    Mux      │  │ Auth Bypass  │  │   OSIN OAuth Server     │ │
│ │ pkg/mux.go  │  │  Paths       │  │  pkg/osinserver/        │ │
│ └─────────────┘  └──────────────┘  └─────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                 Authentication Providers                       │
│ ├── Password Auth (pkg/authenticator/password/)               │
│ ├── External OAuth (pkg/oauth/external/)                     │
│ └── Session Management (pkg/server/session/)                 │
├─────────────────────────────────────────────────────────────────┤
│                  Request Handlers                             │
│ ├── Login Flow (pkg/server/login/)                           │
│ ├── Authorization Grant (pkg/server/grant/)                  │
│ ├── Logout (pkg/server/logout/)                             │
│ └── Provider Selection (pkg/server/selectprovider/)          │
└─────────────────────────────────────────────────────────────────┘
```

## Main Entry Points

### Application Bootstrap
- **`cmd/oauth-server/main.go`**: Primary entry point
  - Sets up signal handling and graceful shutdown
  - Initializes logging and profiling
  - Creates the OAuth server command structure

- **`pkg/cmd/oauth-server/cmd.go`**: Command configuration
  - Handles `--config` flag for OSIN server configuration
  - Validates configuration and starts the server
  - Integrates audit logging capabilities

### Server Configuration
- **`pkg/cmd/oauth-server/server.go`**: Server setup and initialization
  - Creates Kubernetes client configurations
  - Sets up authentication and authorization chains
  - Configures bypass paths for OAuth endpoints
  - Integrates with OpenShift-specific components

## Authentication Architecture

### 1. Password Authentication Providers

Located in `pkg/authenticator/password/`, supporting multiple backends:

#### Available Authenticators
- **`htpasswd/`**: Apache htpasswd file-based authentication
  - Supports bcrypt and SHA-1 password hashing
  - File-based user store with automatic reloading
  - Username validation (no colons allowed)

- **`ldappassword/`**: LDAP directory authentication
  - Connects to LDAP servers for user validation
  - Supports various LDAP configurations

- **`keystonepassword/`**: OpenStack Keystone integration
  - Authenticates against OpenStack identity service
  - Enterprise cloud integration

- **`basicauthpassword/`**: HTTP Basic Authentication
  - Standard HTTP Basic Auth protocol support

- **`allowanypassword/`**: Development/testing authenticator
  - Accepts any password (development use only)

- **`denypassword/`**: Security authenticator
  - Denies all authentication attempts

### 2. External OAuth Providers

Located in `pkg/oauth/external/`, supporting major OAuth providers:

#### Supported Providers
- **GitHub** (`github/`): GitHub OAuth integration
- **GitLab** (`gitlab/`): GitLab OAuth integration  
- **Google** (`google/`): Google OAuth integration
- **OpenID Connect** (`openid/`): Generic OIDC provider support

#### External Provider Flow
- **`handler.go`**: Core external OAuth flow handler
- Implements OAuth2 authorization code flow
- Manages state tokens for CSRF protection
- Handles callback processing and token exchange

### 3. Authentication Interfaces

Defined in `pkg/authenticator/interfaces.go`:

```go
type PasswordAuthenticator interface {
    AuthenticatePassword(ctx context.Context, user, password string) (*authenticator.Response, bool, error)
}

type Assertion interface {
    AuthenticateAssertion(assertionType, data string) (*authenticator.Response, bool, error)
}

type Client interface {
    AuthenticateClient(client api.Client) (*authenticator.Response, bool, error)
}
```

## OAuth2 Server Implementation

### OSIN Integration (`pkg/osinserver/`)

- **`osinserver.go`**: Core OAuth2 server implementation
  - Based on the OSIN OAuth2 library
  - Handles standard OAuth2 endpoints:
    - `/oauth/authorize` - Authorization endpoint
    - `/oauth/token` - Token endpoint  
    - `/oauth/info` - Token info endpoint
  - Custom token generation for enhanced security
  - Comprehensive error handling and logging

### OAuth API Server (`pkg/oauthserver/`)

- **`oauth_apiserver.go`**: Main OAuth server configuration
  - Integrates OSIN with Kubernetes API server framework
  - Manages OAuth clients and user sessions
  - Handles OpenShift-specific OAuth configurations
  - Provides token introspection and validation

## Request Flow Handlers

### Login Flow (`pkg/server/login/`)

- **`login.go`**: Username/password login form handling
  - Renders login forms with CSRF protection
  - Processes login submissions
  - Handles multiple authentication providers
  - Manages login error cases and user feedback

### Authorization Grant Flow (`pkg/server/grant/`)

- **`grant.go`**: OAuth authorization grant handling
  - Displays OAuth scope approval forms
  - Processes user consent decisions
  - Manages granted permissions
  - Integrates with Kubernetes RBAC

### Session Management (`pkg/server/session/`)

- Session creation and validation
- Integration with Kubernetes authentication
- Secure session token management
- Session lifecycle management

### Provider Selection (`pkg/server/selectprovider/`)

- **`selectprovider.go`**: Identity provider selection interface
- Allows users to choose authentication method
- Handles multiple configured providers
- Bootstrap provider configuration

## Security Features

### CSRF Protection (`pkg/server/csrf/`)
- Cross-site request forgery protection
- Secure token generation and validation
- Integration with all form-based flows

### Cryptographic Services (`pkg/server/crypto/`)
- **`sha256.go`**: SHA-256 hashing utilities
- **`random.go`**: Secure random number generation
- **`compare.go`**: Secure string comparison functions

### HTTP Security (`pkg/server/headers/`)
- Security header management
- OAuth-specific header handling
- Content security policies

## Kubernetes Integration

### Authentication Chain
The OAuth server integrates with Kubernetes authentication through:
- **Delegated Authentication**: Uses Kubernetes TokenReview API
- **Service Account Integration**: Supports service account tokens
- **Bootstrap Authentication**: Special handling for bootstrap users

### Authorization Integration
- **Path-based Authorization**: Bypass authentication for specific paths
- **RBAC Integration**: Leverages Kubernetes Role-Based Access Control
- **OpenShift Extended Authorization**: Uses OpenShift's enhanced RBAC model

### Bypass Paths
These paths bypass Kubernetes authentication:
```
/healthz, /healthz/          # Health checks
/oauth/*                     # OAuth endpoints
/login, /login/*            # Login flows
/logout, /logout/           # Logout
/oauth2callback/*           # OAuth callbacks
```

## Configuration Structure

### Main Configuration Types

From `vendor/github.com/openshift/api/osin/v1/types.go`:

```go
type OsinServerConfig struct {
    OAuthConfig      OAuthConfig
    KubeClientConfig KubeClientConfig  
    ServingInfo      ServingInfo
    // ... other fields
}

type OAuthConfig struct {
    MasterCA                    *string
    MasterURL                   string
    MasterPublicURL             string
    AssetPublicURL              string
    IdentityProviders           []IdentityProvider
    MasterClients              map[string]*OAuthClient
    SessionConfig              *SessionConfig
    TokenConfig                TokenConfig
    GrantConfig                GrantConfig
    // ... other fields
}
```

### OAuth Server Config

From `pkg/oauthserver/oauth_apiserver.go`:

```go
type OAuthServerConfig struct {
    GenericConfig *genericapiserver.RecommendedConfig
    ExtraOAuthConfig
}

type ExtraOAuthConfig struct {
    Options      configapi.OAuthConfig
    // ... client interfaces and handlers
}
```

## Operational Features

### Health Checks
- Kubernetes-style health endpoints
- Readiness and liveness probes
- Service status monitoring

### Metrics and Monitoring (`pkg/prometheus/`)
- Prometheus metrics integration
- OAuth-specific metrics collection
- Performance and usage monitoring

### Audit Logging (`pkg/audit/`)
- Comprehensive authentication event logging
- Integration with Kubernetes audit framework
- Configurable audit policies

### Error Handling (`pkg/server/errorpage/`)
- User-friendly error pages
- Localized error messages
- Debugging information for administrators

## OAuth-Proxy Integration

The OAuth server is designed to work seamlessly with oauth-proxy sidecars:

### Proxy Capabilities
- **Authentication Gating**: Block access to services requiring authentication
- **Automatic Redirects**: Redirect unauthenticated users to OAuth login
- **Token Validation**: Validate and refresh OAuth tokens
- **Transparent Auth**: Provide seamless authentication for applications

### Integration Points
- **Token Introspection**: Validate tokens issued by the OAuth server
- **User Info Endpoint**: Retrieve authenticated user information
- **Session Management**: Coordinate session state across services

## Development and Testing

### Testing Infrastructure
- **`pkg/osinserver/teststorage/`**: Test storage implementations
- Mock authenticators for development
- Comprehensive test coverage for OAuth flows

### Development Authenticators
- **Allow-any-password**: For development environments
- **Bootstrap providers**: For initial cluster setup
- **Testing utilities**: Simplified authentication for testing

## Deployment Considerations

### Security Requirements
- **HTTPS Only**: TLS required for all OAuth operations
- **HTTP/1.1 Enforcement**: Avoids HTTP/2 connection reuse issues with wildcard certificates
- **Secure Session Storage**: Encrypted session management
- **CSRF Protection**: Comprehensive cross-site request forgery protection

### High Availability
- **Stateless Design**: Sessions stored externally for horizontal scaling
- **Kubernetes Integration**: Leverages Kubernetes HA capabilities
- **Health Monitoring**: Comprehensive health check endpoints

### Configuration Management
- **File-based Configuration**: YAML configuration files
- **Kubernetes Secrets**: Sensitive data stored as Kubernetes secrets
- **Dynamic Reconfiguration**: Some settings can be updated without restart

## Key Files and Directories

```
cmd/oauth-server/              # Application entry points
pkg/
├── api/                       # API types and interfaces
├── audit/                     # Audit logging
├── authenticator/             # Authentication providers
│   ├── password/              # Password-based authenticators
│   └── request/               # Request-based authenticators
├── cmd/oauth-server/          # Command implementation
├── config/                    # Configuration utilities
├── oauth/                     # OAuth protocol handling
│   ├── external/              # External OAuth providers
│   └── handlers/              # OAuth request handlers
├── oauthserver/               # Main OAuth server
├── osinserver/                # OSIN OAuth2 integration
├── server/                    # HTTP request handlers
│   ├── login/                 # Login flow
│   ├── grant/                 # Authorization grants
│   ├── session/               # Session management
│   └── csrf/                  # CSRF protection
└── userregistry/              # User and identity management
```

## Summary

The OpenShift OAuth server provides a comprehensive authentication solution that:

1. **Bridges Kubernetes and OAuth2**: Seamlessly integrates OAuth2 authentication with Kubernetes authorization
2. **Supports Multiple Providers**: Accommodates various authentication backends and external OAuth providers
3. **Maintains Security**: Implements comprehensive security measures including CSRF protection, secure sessions, and audit logging
4. **Enables User-Friendly Access**: Provides web-based login flows as an alternative to CLI token management
5. **Integrates with Sidecars**: Works with oauth-proxy to provide transparent authentication for applications
6. **Scales with Kubernetes**: Leverages Kubernetes primitives for high availability and configuration management

This architecture makes OpenShift significantly more accessible for end users while maintaining enterprise-grade security and integration capabilities.

## Comparison with Traditional OAuth/OIDC Providers (e.g., Keycloak)

The OpenShift OAuth server is purpose-built for Kubernetes/OpenShift integration rather than being a general-purpose identity provider. Here's how it compares to full-featured solutions like Keycloak:

### Core Architecture Differences

| Feature | OpenShift OAuth Server | Keycloak/Traditional IDPs |
|---------|------------------------|---------------------------|
| **Multi-tenancy** | Single-cluster focused | Multi-realm support |
| **Client Storage** | Kubernetes CRDs | Database-backed |
| **User Management** | Delegates to external providers | Built-in user store + external |
| **Administrative UI** | CLI-only (kubectl/oc) | Full web administration console |
| **Token Format** | OAuth2 access tokens (opaque) | JWT tokens by default |

### 1. **Realm vs Cluster-Centric Model**

**Keycloak Approach:**
```yaml
# Multiple realms for different applications/environments
Realm: production
  - Client: frontend-app
  - Client: api-service
  - Users: managed internally or federated

Realm: development
  - Client: dev-frontend
  - Client: test-api
```

**OpenShift Approach:**
```yaml
# Single OAuth server per cluster
Cluster: production-cluster
  - OAuthClient: console (web UI)
  - OAuthClient: oc-cli (command line)
  - OAuthClient: custom-app
  - Users: always external (LDAP, GitHub, etc.)
```

### 2. **Client Management**

**Keycloak:** Rich web UI for client configuration
- Client scopes, mappers, roles
- Protocol configuration (OIDC, SAML)
- Advanced authentication flows

**OpenShift:** Kubernetes-native client management
```yaml
apiVersion: oauth.openshift.io/v1
kind: OAuthClient
metadata:
  name: my-app
secret: "client-secret-here"
redirectURIs:
  - "https://my-app.example.com/callback"
grantMethod: prompt  # auto, prompt, deny
scopeRestrictions:
  - exactValues: ["user:info", "user:check-access"]
  - clusterRole:
      roleNames: ["view"]
      namespaces: ["my-namespace"]
```

### 3. **Token and Claims Management**

**Keycloak:** Full JWT customization
```javascript
// Rich claims mapping capabilities
{
  "sub": "user-id",
  "name": "John Doe", 
  "email": "john@example.com",
  "roles": ["admin", "user"],
  "groups": ["/sales", "/engineering"],
  "custom_attr": "custom_value"
}
```

**OpenShift:** Simple access tokens with limited claims
```go
// Generated tokens (from tokengen.go)
accessToken := crypto.SHA256Prefix + randomToken()
// Example: "sha256~AbCdEf123456..."

// Limited claims extraction (mainly from external OIDC providers)
identity.Extra[authapi.IdentityPreferredUsernameKey] = preferredUsername
identity.Extra[authapi.IdentityEmailKey] = email  
identity.Extra[authapi.IdentityDisplayNameKey] = name
```

### 4. **Scope System**

**Traditional OAuth:** Flexible custom scopes
```
scopes: ["read:users", "write:posts", "admin:system"]
```

**OpenShift:** RBAC-integrated scopes
```go
// Standard OpenShift scopes (from source analysis)
"user:full"        // Full access to user's resources
"user:info"        // Basic user information  
"user:check-access" // Check user permissions
"role:admin:my-namespace:view" // Namespace-scoped role access

// Scope restrictions tied to Kubernetes RBAC
ClusterRoleScopeRestriction{
    RoleNames: ["view", "edit"], // Which cluster roles
    Namespaces: ["default", "my-app"], // Which namespaces
    AllowEscalation: false // Prevent privilege escalation
}
```

### 5. **Authentication Provider Integration**

**Keycloak:** Comprehensive identity brokering
- OIDC, SAML, LDAP, Kerberos, Social logins
- Complex authentication flows
- Multi-factor authentication
- User registration and self-service

**OpenShift:** Focused on cluster access patterns
```go
// Password authenticators
htpasswd/        // File-based users
ldappassword/    // LDAP integration  
keystonepassword/ // OpenStack Keystone
basicauthpassword/ // HTTP Basic Auth

// External OAuth providers  
github/          // GitHub OAuth
gitlab/          // GitLab OAuth
google/          // Google OAuth
openid/          // Generic OIDC
```

### 6. **Administrative Capabilities**

**Keycloak:**
- Rich web console for all configuration
- User/group management
- Role/permission management  
- Session management
- Audit logs and metrics
- Theme customization
- Event listeners and custom extensions

**OpenShift:**
```bash
# All management via CLI
oc get oauthclient
oc create -f oauth-client.yaml
oc get users
oc get identities

# No built-in user management - users come from external systems
# No web UI for OAuth configuration
# Limited customization options
```

### 7. **Session and State Management**

**Keycloak:**
- Server-side sessions with full lifecycle management
- Session federation across applications
- SSO/SLO (Single Sign-On/Logout)
- Session limits and timeouts

**OpenShift:**
```go
// Session management integrated with Kubernetes auth
SessionConfig struct {
    SessionSecretsFile string // File-based session secrets
    SessionMaxAgeSeconds int32
    SessionName string
}

// Lightweight session handling focused on cluster access
```

### 8. **Protocol Support**

| Protocol | Keycloak | OpenShift OAuth |
|----------|----------|-----------------|
| OAuth 2.0 | ✅ Full | ✅ Core flows only |
| OpenID Connect | ✅ Full provider + consumer | ✅ Consumer only |
| SAML 2.0 | ✅ Full | ❌ Not supported |
| UMA | ✅ Yes | ❌ Not supported |
| Device Flow | ✅ Yes | ❌ Not supported |

**Important Clarification on OIDC Support:**

**Keycloak as OIDC Provider:**
```
# Keycloak provides full OIDC endpoints for other applications
GET /.well-known/openid-configuration    # Discovery
GET /auth/realms/{realm}/protocol/openid-connect/auth     # Authorization  
POST /auth/realms/{realm}/protocol/openid-connect/token   # Token endpoint
GET /auth/realms/{realm}/protocol/openid-connect/userinfo # UserInfo endpoint
GET /auth/realms/{realm}/protocol/openid-connect/certs    # JWKS endpoint
```

**OpenShift OAuth as OIDC Consumer:**
```go
// OpenShift can USE external OIDC providers for authentication
OpenIDIdentityProvider{
    ClientID: "my-app",
    ClientSecret: SecretReference{Name: "oidc-secret"},
    Issuer: "https://my-keycloak.com/auth/realms/myrealm",
    Claims: OpenIDClaims{
        ID: ["sub"],
        PreferredUsername: ["preferred_username"], 
        Email: ["email"],
        Name: ["name"],
    },
}
```

**OpenShift OAuth Endpoints (OAuth 2.0 only):**
```
# OpenShift provides these OAuth 2.0 endpoints (not full OIDC)
GET /oauth/authorize     # OAuth 2.0 authorization
POST /oauth/token        # OAuth 2.0 token exchange  
GET /oauth/info          # Token info (non-standard)

# Missing OIDC-specific endpoints:
# ❌ No /.well-known/openid-configuration
# ❌ No /userinfo endpoint
# ❌ No JWKS endpoint  
# ❌ No ID tokens issued
```

### 9. **Operational Characteristics**

**Keycloak:**
- Standalone service with its own database
- Horizontal scaling with clustering
- Rich monitoring and metrics
- Complex configuration management
- Backup/restore procedures

**OpenShift OAuth:**
- Embedded in cluster control plane
- Leverages Kubernetes primitives for HA
- Configuration via Kubernetes objects
- Integrated with cluster lifecycle
- Minimal operational overhead

### 10. **Use Case Alignment**

**Choose Keycloak/Traditional IDP when:**
- Multiple applications across different environments
- Rich user management requirements
- Complex authentication flows
- SAML integration needed
- Custom claims/attributes required
- Multi-protocol support needed

**OpenShift OAuth is optimal when:**
- Kubernetes/OpenShift-centric environment
- Simple authentication needs for cluster access
- Kubernetes-native operational model preferred
- Minimal external dependencies desired
- RBAC integration is primary concern

### Summary

The OpenShift OAuth server is **not a replacement** for full-featured identity providers like Keycloak. Instead, it's a **specialized authentication gateway** designed specifically for Kubernetes/OpenShift clusters. It excels at:

1. **Simplicity**: Minimal configuration and operational overhead
2. **Integration**: Deep integration with Kubernetes RBAC and resources  
3. **Cluster-focused**: Optimized for cluster access patterns
4. **Cloud-native**: Follows Kubernetes operational patterns

However, it lacks many enterprise IDP features like user management, rich claims mapping, multi-protocol support, and administrative UIs. For complex identity requirements, organizations typically use OpenShift OAuth in conjunction with enterprise identity providers, where the external IDP handles user management and the OpenShift OAuth server handles cluster-specific authentication flows. 

## Example

```
#!/bin/bash
#
# This script creates a temporary OpenShift OAuthClient for testing purposes.
# It requires cluster-admin permissions and the 'oc' CLI.
#
# Usage:
#   ./create-oauth-client.sh [CLIENT_ID]
#
# If CLIENT_ID is not provided, "my-bash-test-client" will be used.

# --- Configuration ---
set -euo pipefail
CLIENT_ID=${1:-"my-bash-test-client"}

# --- Prerequisite Checks ---
if ! command -v oc &> /dev/null; then
    echo "❌ Error: 'oc' command not found. Please install the OpenShift CLI and log in."
    exit 1
fi

if ! oc whoami &> /dev/null; then
    echo "❌ Error: Not logged into an OpenShift cluster. Please run 'oc login' first."
    exit 1
fi

echo "👍 Pre-flight checks passed. Using Client ID: $CLIENT_ID"

# --- Get Cluster-Specific URLs ---
echo "🔎 Discovering cluster's OAuth endpoints..."
OAUTH_ROUTE_HOST=$(oc get route oauth-openshift -n openshift-authentication -o jsonpath='{.spec.host}')
if [ -z "$OAUTH_ROUTE_HOST" ]; then
    echo "❌ Error: Could not find the 'oauth-openshift' route in the 'openshift-authentication' namespace." >&2
    echo "   Please ensure you have the correct permissions." >&2
    exit 1
fi
# The token display page is a safe and convenient redirect URI for testing.
REDIRECT_URI="https://${OAUTH_ROUTE_HOST}/oauth/token/display"
AUTHORIZE_URL="https://${OAUTH_ROUTE_HOST}/oauth/authorize"
echo "   Redirect URI set to: $REDIRECT_URI"

# --- Generate Client Secret ---
echo "🔐 Generating a secure client secret..."
CLIENT_SECRET=$(openssl rand -base64 48 | tr -d '\n' | tr -dc 'a-zA-Z0-9' | head -c 40)

# --- Create OAuthClient Resource ---
echo "🚀 Creating OAuthClient resource..."

# Use a heredoc to pass the YAML directly to `oc apply`.
# This avoids creating temporary files.
oc apply -f - <<EOF
apiVersion: oauth.openshift.io/v1
kind: OAuthClient
metadata:
  name: ${CLIENT_ID}
# The secret is stored directly in the CR.
secret: "${CLIENT_SECRET}"
redirectURIs:
  - "${REDIRECT_URI}"
# 'prompt' forces the user to approve the grant, which is best for testing.
grantMethod: prompt
EOF

# --- Output Final Results ---
echo ""
echo "------------------------------------------------------------------"
echo "✅ OAuth Client '$CLIENT_ID' created successfully!"
echo "------------------------------------------------------------------"
echo ""
echo "   Client ID:      ${CLIENT_ID}"
echo "   Client Secret:  ${CLIENT_SECRET}"
echo ""
echo "--- How to Test ---"
echo "1. Visit the following authorization URL in your browser:"
echo "   (This URL uses the 'token' response type for simple testing)"
echo ""
echo "   ${AUTHORIZE_URL}?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${REDIRECT_URI}"
echo ""
echo "2. Log into OpenShift and approve the permissions grant for the client."
echo "3. You will be redirected, and your new access token will be displayed on the screen."
echo ""
echo "--- How to Clean Up ---"
echo "When you are finished, run this command to delete the client:"
echo "   oc delete oauthclient ${CLIENT_ID}"
echo ""
echo "------------------------------------------------------------------"
```